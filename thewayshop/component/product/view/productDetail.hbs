{{#section 'style'}}
<style>
    .star-container label {
        cursor: pointer;
        display: grid;
    }

    .star-container i {
        width: 3rem;
        height: 3rem;
        padding: 0.15rem;
        grid-column: 1;
        grid-row: 1;
        
    }
    .star-container .substar{
        color: #d33b33; 
        z-index: -1;
    } 

    /* hide radio buttons */

    input[name="star"] {
        display: inline-block;
        width: 0;
        opacity: 0;
        margin-left: -2px;
    }

    .star-source {
        width: 0;
        height: 0;
        opacity: 0.3;
    }

    .star {
        color: transparent;
        transition: color 0.2s ease-in-out;
    }

    .star-container {
        display: flex;
        flex-direction: row-reverse;
        justify-content: center;
    }

    label:hover ~ label .star,
    i.star:hover,
    input[name="star"]:focus ~ label .star,
    input[name="star"]:checked ~ label .star {
        color: #d33b33;
    }

    input[name="star"]:checked + label .star {
        animation: starred 0.5s;
    }

    input[name="star"]:checked + label {
        animation: scaleup 1s;
    }

    #rating{
        display: flex;
        align-items: center;
    }

    #rating .paging-icon{
        cursor: pointer;
        color: #d33b33;
        z-index: 10;
    }
    #rating .paging-icon:hover{
        color: :#691712;
    }
    @keyframes scaleup {
        from {
            transform: scale(1.2);
        }
        to {
            transform: scale(1);
        }
        }

        @keyframes starred {
        from {
            color: #691712;
        }
        to {
            color: #d33b33;
        }
    }


</style>
{{/section}}
<!-- Start Shop Detail  -->
<div class="shop-detail-box-main">
    <div class="container">
        <div class="row">
            <div class="col-xl-5 col-lg-5 col-md-6">
                <div id="carousel-example-1" class="single-product-slider carousel slide" data-ride="carousel">
                    <div class="carousel-inner" role="listbox">
                        <div class="carousel-item active"> <img class="d-block w-100 min-vh-100" src="{{product.image}}" alt="First slide" height="415" style="object-fit: scale-down;"> </div>
                        <div class="carousel-item"> <img class="d-block w-100 min-vh-100" src="{{pro_image.[0].image}}" alt="Second slide" height="415" style="object-fit: scale-down;"> </div>
                        <div class="carousel-item"> <img class="d-block w-100 min-vh-100" src="{{pro_image.[1].image}}" alt="Third slide" height="415" style="object-fit: scale-down;"> </div>
                    </div>
                    <a class="carousel-control-prev" href="#carousel-example-1" role="button" data-slide="prev"> 
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="sr-only">Previous</span> 
                </a>
                    <a class="carousel-control-next" href="#carousel-example-1" role="button" data-slide="next"> 
                    <i class="fa fa-angle-right" aria-hidden="true"></i> 
                    <span class="sr-only">Next</span> 
                </a>
                    <ol class="carousel-indicators">
                        <li data-target="#carousel-example-1" data-slide-to="0" class="active">
                            <img class="d-block w-100 img-fluid" src="{{product.image}}" alt="" />
                        </li>
                        <li data-target="#carousel-example-1" data-slide-to="1">
                            <img class="d-block w-100 img-fluid" src="{{pro_image.[0].image}}" alt="" />
                        </li>
                        <li data-target="#carousel-example-1" data-slide-to="2">
                            <img class="d-block w-100 img-fluid" src="{{pro_image.[1].image}}" alt="" />
                        </li>
                    </ol>
                </div>
            </div>
            <div class="col-xl-7 col-lg-7 col-md-6">
                <div class="single-product-details">
                    <h2>{{product.title}}</h2>
                    <h5>${{product.price}}</h5>
                    <p class="available-stock"><span> More than {{product.available}} available / <a href="#">{{product.sold}} sold </a></span></p>
                    <h4>Short Description:</h4>
                    <p>{{product.description}} </p>
                    <ul>
                        <li>
                            <div class="form-group size-st">
                                <label class="size-label">Size</label>
                                <select id="basic" class="selectpicker show-tick form-control">
                        <option value="0">Size</option>
                        <option value="0">S</option>
                        <option value="1">M</option>
                        <option value="1">L</option>
                        <option value="1">XL</option>
                        <option value="1">XXL</option>
                        <option value="1">3XL</option>
                        <option value="1">4XL</option>
                    </select>
                            </div>
                        </li>
                        <li>
                            <div class="form-group quantity-box">
                                <label class="control-label">Quantity</label>
                                <input class="form-control" value="0" min="0" max="20" type="number">
                            </div>
                        </li>
                    </ul>

                    <div class="price-box-bar">
                        <div class="cart-and-bay-btn">
                            <a class="btn hvr-hover" data-fancybox-close="" href="#">Buy New</a>
                            <a class="btn hvr-hover" data-fancybox-close="" href="#">Add to cart</a>
                        </div>
                    </div>

                    <div class="add-to-btn">
                        <div class="add-comp">
                            <a class="btn hvr-hover" href="#"><i class="fas fa-heart"></i> Add to wishlist</a>
                            <a class="btn hvr-hover" href="#"><i class="fas fa-sync-alt"></i> Add to Compare</a>
                        </div>
                        <div class="share-bar">
                            <a class="btn hvr-hover" href="#"><i class="fab fa-facebook" aria-hidden="true"></i></a>
                            <a class="btn hvr-hover" href="#"><i class="fab fa-google-plus" aria-hidden="true"></i></a>
                            <a class="btn hvr-hover" href="#"><i class="fab fa-twitter" aria-hidden="true"></i></a>
                            <a class="btn hvr-hover" href="#"><i class="fab fa-pinterest-p" aria-hidden="true"></i></a>
                            <a class="btn hvr-hover" href="#"><i class="fab fa-whatsapp" aria-hidden="true"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="special-menu text-center">
                    <div class="button-group filter-button-group">
                        <button class="active" data-filter=".realted-product" id = "btn-related">Related Products</button>
                        <button data-filter=".rating" id= "btn-rating">Rating</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row my-5 d-flex justify-content-center">
            <div class="col-lg-12 " id="related-product">
                <div class="featured-products-box owl-carousel owl-theme">
                    {{#each products}}
                    <div class="item">
                        <div class="products-single fix">
                            <div class="box-img-hover">
                                <img src="{{this.image}}" class="img-fluid" alt="Image" style="object-fit: scale-down;" height="330">
                                <div class="mask-icon">
                                    <ul>
                                        <li><a href="/product/{{this.id}}" data-toggle="tooltip" data-placement="right" title="View"><i class="fas fa-eye"></i></a></li>
                                        <li><a href="#" data-toggle="tooltip" data-placement="right" title="Compare"><i class="fas fa-sync-alt"></i></a></li>
                                        <li><a href="#" data-toggle="tooltip" data-placement="right" title="Add to Wishlist"><i class="far fa-heart"></i></a></li>
                                    </ul>
                                    <a class="cart" href="./myaccount/cart">Add to Cart</a>
                                </div>
                            </div>
                            <div class="why-text">
                                <h4>{{this.title}}</h4>
                                <h5> ${{this.price}}</h5>
                            </div>
                        </div>
                    </div>
                    {{else}}
                    <h3>There is no related to this product</h3>
                    {{/each}}
                </div>
            </div>
            <div class="row" id="rating" style="display: none;">
                <i class="fas fa-arrow-circle-left paging-icon" id="previous"></i>
                <div class="col-lg-12 row" id="rating-container">
                    {{#each rating}}
                    <div class="col-4">
                        <div class="row">
                            <div class="col-2">
                                <img {{#if this.image}}src="{{this.image}}"{{else}}src="/images/default-avatar.png" {{/if}}alt="avt" width="50" height="50">
                            </div>
                            <div class="col-10">
                                <div class="row">
                                    <div class="col-7">
                                        <span><b>{{this.name}}</b></span>
                                    </div>
                                    <div class="col-5">
                                        {{#times this.star}}
                                        <i class="fa fa-star fa-xs" style="color: #d33b33;"></i>
                                        {{/times}}
                                    </div>
                                </div>
                                <p>{{this.content}}</p>
                            </div>
                        </div>
                    </div>
                    {{/each}}
                </div>
                <i class="fas fa-arrow-circle-right paging-icon" id="next"></i>
                {{#if user}}
                <form class="col-lg-12 row">
                    <div class="star-container col-4" >
                        <input type="radio" name="star" value="5" id="five">
                        <label for="five">
                            <i class="far fa-star substar" >
                            </i>
                            <i class="fa fa-star star">
                            <a xlink:href="#star"></a>
                            </i>
                        </label>
                        <input type="radio" name="star" value="4" id="four">
                        <label for="four">
                            <i class="far fa-star substar" ></i>
                            <i class="fa fa-star star">
                            <a xlink:href="#star"></a>
                            </i>
                        </label>
                        <input type="radio" name="star" value="3" id="three">
                        <label for="three">
                            <i class="far fa-star substar" ></i>
                            <i class="fa fa-star star">
                            <a xlink:href="#star"></a>
                            </i>
                        </label>
                        <input type="radio" name="star" value="2"id="two">
                        <label for="two">
                            <i class="far fa-star substar" ></i>
                            <i class="fa fa-star star">
                            <a xlink:href="#star"></a>
                            </i>
                        </label>
                        <input type="radio" name="star" value="1" id="one">
                        <label for="one">
                            <i class="far fa-star substar" ></i>
                            <i class="fa fa-star star">
                            <a xlink:href="#star"></a>
                            </i>
                        </label>
                    </div>
                    <div class="col-6">
                        <input type="text" id="inp-rating-content" class="form-control" placeholder="Write what you think about this product">
                    </div>
                    <div class="col-2">
                        <button id="btn-add-rating" class="btn btn-danger" data-user_id="{{user.id}}" data-pro_id="{{product.id}}">Add</button>
                    </div>
                </form>
                {{else}}
                <span><a href="/login">Login</a> to leave a rating.</span>
                {{/if}}
            </div>
        </div>
    </div>
</div>
<!-- End Cart -->
{{#section 'script'}}
<script>
    let numberRating = {{{number_rating}}}
    let maxPageRating = Math.ceil(numberRating/9);
    const product_id = "{{{product.id}}}";
    let ratingCache =[];
    let currentPage=1;
    $('document').ready(()=>{
        if(maxPageRating===0){
            console.log('No rating')
            return;
        }
        $.get(`/api/product/rating?proid=${product_id}`,(data,status)=>{
            if(status==="success"){
                data.slice().reverse().forEach(rating=>{
                    addRating(rating);
                })
                ratingCache[1]=data;
            }
            else{
                console.log('error',data);
            }
        })
    })
    document.querySelector('#previous').addEventListener('click',()=>{
        if(maxPageRating===0){
            return;
        }
        if(currentPage===1){
            return;
        }
        if(ratingCache[currentPage-1]){
            document.querySelector('#rating-container').innerHTML ='';
            const data = ratingCache[currentPage-1];
            data.slice().reverse().forEach(rating=>{
                addRating(rating);
            })
            currentPage--;
        }
        else{
            $.get(`/api/product/rating?proid=${product_id}&page=${currentPage-1}`,(data,status)=>{
                if(status==='success'){
                    currentPage--;
                    document.querySelector('#rating-container').innerHTML ='';
                    data.slice().reverse().forEach(rating=>{
                        addRating(rating);
                    })
                    ratingCache[currentPage]=data;
                }
            })
        }
    })
    document.querySelector('#next').addEventListener('click',()=>{
        if(maxPageRating===0){
            return;
        }
        if(currentPage===maxPageRating){
            return;
        }
        if(ratingCache[currentPage+1]){
            document.querySelector('#rating-container').innerHTML ='';
            const data = ratingCache[currentPage+1];
            data.slice().reverse().forEach(rating=>{
                addRating(rating);
            })
            currentPage++;
        }
        else{
            $.get(`/api/product/rating?proid=${product_id}&page=${currentPage+1}`,(data,status)=>{
                if(status==='success'){
                    currentPage++;
                    document.querySelector('#rating-container').innerHTML ='';
                    data.slice().reverse().forEach(rating=>{
                        addRating(rating);
                    })
                    ratingCache[currentPage]=data;
                }
            })
        }
    })



    const btn_related = document.querySelector('#btn-related');
    const btn_rating = document.querySelector('#btn-rating');
    btn_related.addEventListener('click',()=>{
        if(!btn_related.classList.contains('active')){
            $('#rating').fadeOut(0);
            $('#related-product').fadeIn(700);
        }
    })
    btn_rating.addEventListener('click',()=>{
        if(!btn_rating.classList.contains('active')){
            $('#related-product').fadeOut(0);
            $('#rating').fadeIn(700);
        }
    })
    
    const btn_add_rating = document.querySelector('#btn-add-rating');
    const one = document.querySelector('#one');
    const two = document.querySelector('#two');
    const three = document.querySelector('#three');
    const four = document.querySelector('#four');
    const five = document.querySelector('#five');
    btn_add_rating.addEventListener('click',(e)=>{
        e.preventDefault();
        if(!document.querySelector('#inp-rating-content').value){
            document.querySelector('#inp-rating-content').focus();
            return;
        }
        let star = 0;
        if(one.checked){
            one.checked = false;
            star = 1;
        }
        else if(two.checked){
            two.checked = false;
            star = 2;
        }
        else if(three.checked){
            three.checked = false;
            star = 3;
        }
        else if(four.checked){
            four.checked = false;
            star = 4;
        }
        else if(five.checked){
            five.checked = false;
            star = 5;
        }
        if(star === 0){
            document.querySelector('.star-container').focus();
            return;
        }
        const content = document.querySelector('#inp-rating-content').value;
        const user_id = btn_add_rating.dataset.user_id;
        const product_id = btn_add_rating.dataset.pro_id;
        $.post('/api/product/rating',{
            user_id:user_id,
            product_id:product_id,
            star:star,
            content:content
        },(data,status)=>{
            if(status==='success'){
                document.querySelector('#inp-rating-content').value =''
                ratingCache =[];
                currentPage = 2;
                numberRating++;
                maxPageRating = Math.ceil(numberRating/9);
                document.querySelector('#previous').click();
            }
            else{
                console.log('error',data);
            }
        })
    })

    function addRating(rating){
        const rating_container = document.querySelector('#rating-container');
        if(rating_container.childElementCount >= 9){
            rating_container.removeChild(rating_container.lastElementChild);
        }
        let star ='';
        for(let i =0;i<rating.star;i++){
            star+= '<i class="fa fa-star fa-xs" style="color: #d33b33;"></i>';
        }
        let div =`<div class="col-4">
                        <div class="row">
                            <div class="col-2">
                                <img src="${rating.image?rating.image:'/images/default-avatar.png'}"alt="avt" width="50" height="50">
                            </div>
                            <div class="col-10">
                                <div class="row">
                                    <div class="col-7">
                                        <span><b>${rating.name}</b></span>
                                    </div>
                                    <div class="col-5">
                                        ${star}
                                    </div>
                                </div>
                                <p>${rating.content}</p>
                            </div>
                        </div>
                    </div>`;
        rating_container.innerHTML = div + rating_container.innerHTML;
    }
</script>
{{/section}}